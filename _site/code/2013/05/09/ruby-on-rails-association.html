<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Ruby on Rails 表关联使用小总结</title>
   <meta name="author" content="buxiangshuo" />
   <meta name="keywords" content="互联网,设计师,产品设计,交互设计,心理学爱好者,敏捷开发,用户体验,情感化,Ruby on Rails,PHP,文字控,爱音乐,爱旅游,简单,知足" />
   <meta name="description" content="互联网产品设计爱好者,交互设计爱好者,喜欢多角度思考问题,崇尚敏捷开发与情感化设计,注重团队建设,勉强及格的爱人和朋友" />
   
   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/css/screen.css" type="text/css" media="screen, projection" />
   <link href="/assets/css/syntax.css" type="text/css" rel="stylesheet" />
   <link rel="shortcut icon" href="/favicon.ico" />

</head>
<body>
<!-- fork img -->
<a href="https://github.com/buxiangshuo"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>

<div class="site">
  <div class="title">
    <a href="/"><img src="/assets/img/logo.png"/></a>
    <a class="extra" href="/">Home</a>
	<a class="extra" href="/feeling.html">Feeling</a>
	<a class="extra" href="/think.html">Think</a>
	<a class="extra" href="/code.html">Code</a>
	<a class="extra" href="/design.html">Design</a>
    <a class="extra" href="/music.html">Music</a>
    <a class="extra" href="/resume/index.html">Resume</a>
  </div>

  <div id="post">
  <h1>Ruby on Rails 表关联使用小总结</h1>

<p class="meta">15 May 2013 - 武汉</p>

<p>最近一直在写信息系统设计的作业，我们小组做了一个关于团队任务管理的应用，这是一个用于小型团队的在线任务管理程序，逻辑非常简单，就是基于项目为核心。由于刚刚学习 <code>rails</code> 没多久，很喜欢，于是决定用这个来开发。我们的逻辑是每个项目有一个发起者，其他人可以加入项目，也可以退出项目，同时自己也可以发起项目，简单说项目和用户这两个 <code>model</code> 之间是多对多关系，那么就需要用到 <code>association</code> 了，将两个表之间建立一定的联系</p>

<p>对于各种模式，我这里就不熬述了，官方文档说的很清楚，其他教程也很多，例如这里，重点说一下 <code>many to many</code></p>

<h2>Many-To-Many</h2>

<p>这里事先有两个 <code>model</code> 一个叫做 <code>project</code>，另一个叫做 <code>user</code>，当然这里是用的 <code>devise</code> 的 <code>User</code>，我们再建立一个 <code>model</code> 名字叫做 <code>duty</code> ， 这个模型用来搭建前两个模型的联系</p>
<div class="highlight"><pre><code class="ruby"><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">duty</span> <span class="n">project_id</span><span class="ss">:integer</span> <span class="n">user_id</span><span class="ss">:integer</span>
</code></pre></div>
<p>其中后两者定义了两个 <code>Foreign Keys</code> ，<code>project_id</code> 会与 <code>Project</code> 表的 <code>id</code> 建立一一对应， <code>user_id</code> 对应 <code>User</code> 的 <code>id</code> ，这样一来便搭建了一个 <code>Join Table</code>，一个只包含外键的模型</p>

<p>三个模型在关系上的代码如下:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">has_many</span> <span class="ss">:duties</span>
    <span class="n">has_many</span> <span class="ss">:projects</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:duties</span>
 <span class="k">end</span>

<span class="k">class</span> <span class="nc">Duty</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">belongs_to</span> <span class="ss">:user</span>
    <span class="n">belongs_to</span> <span class="ss">:project</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">has_many</span> <span class="ss">:duties</span>
    <span class="n">has_many</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:duties</span>
<span class="k">end</span>
</code></pre></div>
<p>那么无论是在 <code>view</code> 或者 <code>controller</code> 中，按照以下代码便可创建一个新的关联（具体变量视情况而定）：</p>

<p>创建指定 <code>project</code> 与 <code>user</code> 之间的联系</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Duty</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:project_id</span> <span class="o">=&gt;</span> <span class="vi">@project</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div>
<p>删除指定的一个关联</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Duty</span><span class="o">.</span><span class="n">find_by_project_id_and_user_id</span><span class="p">(</span><span class="vi">@project</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</code></pre></div>
<p>删除与指定 <code>project</code> 相关的所有关联</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Duty</span><span class="o">.</span><span class="n">find_by_project_id</span><span class="p">(</span><span class="vi">@project</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</code></pre></div>
<p>删除与指定 <code>user</code> 相关的所有关联</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Duty</span><span class="o">.</span><span class="n">find_by_user_id</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</code></pre></div>
<p>类似关注用户，参加一个小组等等的功能，都可以这样来设计一下，不同的联系用不同的中间模型来处理关联，不仅方便业务逻辑处理，也非常方便一些关于 <code>feed</code> 或者 <code>动态列表</code> 的功能的实现</p>

<p>例如以上例子中，如果想要动态显示项目与用户之间的关系，就可以调用 <code>Duty</code> 的数据操作来显示变化</p>

<h2>参数介绍</h2>

<p>无论是 <code>belongs_to</code>，<code>has_one</code>，还是 <code>has_many</code> ，都可以添加一些参数，以下列举几个</p>

<p><strong>class_name</strong></p>

<p>可以将关联的类别名称换成你想要的名称，示例代码如下:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Doc</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">belongs_to</span> <span class="ss">:Project</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Task&quot;</span>
 <span class="k">end</span>
</code></pre></div>
<p>需要注意的是在这里 <code>Task</code> 是 <code>Doc</code> 的父级，也就是 <code>Project</code>，只不过在这个关联中重新命名而已</p>

<p><strong>foreign_key</strong></p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Doc</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">belongs_to</span> <span class="ss">:Project</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Task&quot;</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;project_id&quot;</span>
 <span class="k">end</span>
</code></pre></div>
<p><strong>order</strong></p>

<p><code>has_many</code> 可以通过 <code>:order</code> 来指定顺序</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">has_many</span> <span class="ss">:project</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;id desc&quot;</span>
    <span class="c1">#...</span>
 <span class="k">end</span>
</code></pre></div>
<p><strong>dependent</strong></p>

<p>例如需要删除一个项目，然后项目下的文档便全部失效，同时删除等等，就需要用到 <code>dependent</code></p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
    <span class="n">has_many</span> <span class="ss">:docs</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span> 
    <span class="c1">#...</span>
 <span class="k">end</span>
</code></pre></div>
<p>这样在项目删除的时候，相应的其关联的文档也会全部删除，如果参数改为 <code>delete</code>，则不会全部删除</p>

<p>好了，这次先写这么多，以后还会陆续写一些经验，并且及时修改更正</p>

<p>Enjoy！</p>

  <p></p>
  <div id="related">
    <h3>最近文章</h3>
    <ul class="posts">
    
      <li><span>29 Sep 2013</span> &nbsp;&raquo;&nbsp; <a href="/design/2013/09/29/simple-and-simple-design.html">简约至上读书笔记</a></li>
    
      <li><span>14 Sep 2013</span> &nbsp;&raquo;&nbsp; <a href="/design/2013/09/14/see-the-same-things.html">为观察结构优化我们的视觉</a></li>
    
      <li><span>14 Jul 2013</span> &nbsp;&raquo;&nbsp; <a href="/feeling/2013/07/14/the-beginning-of-beijing.html">北京实习之初</a></li>
    
    </ul>
  </div>

  <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'wuyanyu'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	
	<a href="#" class="totop">Top</a>
</div>




  <div class="footer">
    <div class="contact">
      <p>
        Built based on <a href="https://github.com/mojombo/jekyll/">Jekyll</a><br />
        Theme by <a href="http://tom.preston-werner.com/">Tom</a><br />
        Hosting on <a href="http://page.github.com/">GitHub Page</a><br />
        Thanks for <a href="https://github.com/mojombo/">Mojombo</a>
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/buxiangshuo/">Github</a><br />
        <a href="http://weibo.com/moshuohua/">微博</a><br />
        <a href="http://www.douban.com/people/47516504/">豆瓣</a><br />
        <a href="mailto:moshuohua@gmail.com">Gmail</a>
      </p>
    </div>
  </div>
</div>

<!-- disqus comment count -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'wuyanyu'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<!-- baidu script -->

<script type="text/javascript">
   var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
   document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F6b94dd9b0c69ce6e1bea7a33a4f2dc5d' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- google script -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30271188-2', 'wuyanyu.com');
  ga('send', 'pageview');

</script>

</body>
</html>
